<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntarAalay - AR Home Decor Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/@google/model-viewer@3.0.1/dist/model-viewer.min.js" type="module"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        .ar-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        model-viewer {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            max-width: 90%;
        }
        
        .control-btn {
            background: #C6A75E;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        
        .control-btn:hover {
            background: #B8941F;
            transform: translateY(-2px);
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            max-width: 250px;
        }
        
        .info-panel h3 {
            margin-bottom: 10px;
            color: #C6A75E;
            font-size: 16px;
        }
        
        .info-panel p {
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .vastu-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .vastu-indicator.excellent {
            border: 2px solid #32CD32;
        }
        
        .vastu-indicator.good {
            border: 2px solid #FFD700;
        }
        
        .vastu-indicator.poor {
            border: 2px solid #FF6347;
        }
        
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            text-align: center;
            max-width: 300px;
        }
        
        .error-message h3 {
            margin-bottom: 10px;
        }
        
        .error-message button {
            background: white;
            color: #dc3545;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        .loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #C6A75E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .furniture-info {
            position: fixed;
            top: 160px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            max-width: 250px;
        }
        
        .furniture-info h4 {
            margin-bottom: 8px;
            color: #C6A75E;
            font-size: 14px;
        }
        
        .furniture-info p {
            margin: 3px 0;
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <h2>üè† Loading AR Home Decor...</h2>
        <p>Preparing your Vastu-compliant space</p>
    </div>
    
    <!-- Error Message -->
    <div id="error-message" class="error-message" style="display: none;">
        <h3>‚ùå AR Not Available</h3>
        <p>Your device doesn't support AR or camera access was denied.</p>
        <p>You can still view the 3D furniture in regular mode.</p>
        <button onclick="continueWithoutAR()">Continue Without AR</button>
    </div>
    
    <!-- AR Container -->
    <div class="ar-container">
        <model-viewer
            id="ar-viewer"
            src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb"
            ios-src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb"
            ar
            ar-modes="scene-viewer quick-look webxr"
            camera-controls
            environment-image="neutral"
            exposure="0.8"
            shadow-intensity="1"
            ar-scale="auto"
            style="width: 100%; height: 100vh;"
            alt="Home Decor AR Visualization"
            ar-placement="floor"
            min-camera-orbit="auto auto 0.5m"
            max-camera-orbit="auto auto 10m">
        </model-viewer>
    </div>
    
    <!-- Room Info Panel -->
    <div class="info-panel">
        <h3 id="room-name">Living Room</h3>
        <p><strong>Style:</strong> <span id="room-style">Modern</span></p>
        <p><strong>Vastu Zone:</strong> <span id="vastu-zone">North</span></p>
        <p><strong>Element:</strong> <span id="element">Air</span></p>
    </div>
    
    <!-- Furniture Info -->
    <div class="furniture-info">
        <h4 id="furniture-name">Modern Sofa</h4>
        <p><strong>Material:</strong> <span id="furniture-material">Fabric</span></p>
        <p><strong>Size:</strong> <span id="furniture-size">2m x 0.8m</span></p>
        <p><strong>Vastu:</strong> <span id="furniture-vastu">West placement</span></p>
    </div>
    
    <!-- Vastu Indicator -->
    <div id="vastu-indicator" class="vastu-indicator">
        <h4>üßò Vastu Score</h4>
        <p id="vastu-score">85%</p>
        <p id="vastu-status">Excellent</p>
    </div>
    
    <!-- Controls -->
    <div class="controls">
        <button class="control-btn" onclick="changeRoom()">üè† Change Room</button>
        <button class="control-btn" onclick="changeFurniture()">ü™ë Change Item</button>
        <button class="control-btn" onclick="changeStyle()">üé® Change Style</button>
        <button class="control-btn" onclick="checkVastu()">üßò Vastu Check</button>
        <button class="control-btn" onclick="takeScreenshot()">üì∏ Screenshot</button>
        <button class="control-btn" onclick="resetView()">üîÑ Reset View</button>
    </div>
    
    <script>
        // REAL HOME DECOR FURNITURE CONFIGURATIONS
        const roomConfigs = {
            living: {
                name: 'Living Room',
                style: 'Modern',
                vastuZone: 'North',
                element: 'Air',
                score: 85,
                furniture: [
                    {
                        name: 'Modern Sofa',
                        material: 'Premium Fabric',
                        size: '2m x 0.8m',
                        vastu: 'West placement recommended',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Coffee Table',
                        material: 'Solid Wood',
                        size: '1.2m x 0.6m',
                        vastu: 'Center of room',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'TV Unit',
                        material: 'Engineered Wood',
                        size: '1.8m x 0.4m',
                        vastu: 'East wall placement',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Bookshelf',
                        material: 'Solid Wood',
                        size: '0.8m x 2m',
                        vastu: 'North wall placement',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    }
                ]
            },
            bedroom: {
                name: 'Bedroom',
                style: 'Modern',
                vastuZone: 'Southwest',
                element: 'Earth',
                score: 90,
                furniture: [
                    {
                        name: 'King Size Bed',
                        material: 'Solid Wood with Upholstery',
                        size: '2m x 1.8m',
                        vastu: 'Southwest corner, head South',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Wardrobe',
                        material: 'Engineered Wood',
                        size: '2.5m x 0.6m',
                        vastu: 'North or West wall',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Nightstand',
                        material: 'Solid Wood',
                        size: '0.4m x 0.4m',
                        vastu: 'Beside bed, West side',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Dressing Table',
                        material: 'Wood with Mirror',
                        size: '1.2m x 0.5m',
                        vastu: 'North wall placement',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    }
                ]
            },
            kitchen: {
                name: 'Kitchen',
                style: 'Modern',
                vastuZone: 'Southeast',
                element: 'Fire',
                score: 88,
                furniture: [
                    {
                        name: 'Kitchen Cabinets',
                        material: 'Plywood with Finish',
                        size: '3m x 0.6m',
                        vastu: 'South and East walls',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Cooking Platform',
                        material: 'Granite Top',
                        size: '1.2m x 0.6m',
                        vastu: 'East direction facing',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Refrigerator',
                        material: 'Stainless Steel',
                        size: '0.6m x 0.6m',
                        vastu: 'Southeast corner',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Dining Table',
                        material: 'Solid Wood',
                        size: '1.8m x 0.9m',
                        vastu: 'Northwest area',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    }
                ]
            },
            office: {
                name: 'Home Office',
                style: 'Modern',
                vastuZone: 'West',
                element: 'Air',
                score: 82,
                furniture: [
                    {
                        name: 'Executive Desk',
                        material: 'Solid Wood',
                        size: '1.8m x 0.8m',
                        vastu: 'East or North facing',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Ergonomic Chair',
                        material: 'Mesh and Metal',
                        size: '0.6m x 0.6m',
                        vastu: 'Behind desk, facing East',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Bookshelf',
                        material: 'Engineered Wood',
                        size: '0.8m x 2m',
                        vastu: 'South wall placement',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    },
                    {
                        name: 'Filing Cabinet',
                        material: 'Metal',
                        size: '0.4m x 1.3m',
                        vastu: 'Northwest corner',
                        model: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/DamagedHelmet/glTF-Binary/DamagedHelmet.glb'
                    }
                ]
            }
        };
        
        const styles = ['Modern', 'Traditional', 'Vastu', 'Minimalist'];
        let currentRoom = 'living';
        let currentStyleIndex = 0;
        let currentFurnitureIndex = 0;
        
        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                designId: params.get('designId') || 'demo',
                roomId: params.get('roomId') || 'demo',
                userId: params.get('userId') || 'demo',
                style: params.get('style') || 'modern'
            };
        }
        
        // Initialize AR
        function initAR() {
            console.log('üè† Initializing REAL AR Home Decor...');
            
            const params = getUrlParams();
            console.log('üì± User parameters:', params);
            
            // Hide loading after 1 second
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                checkARSupport();
            }, 1000);
            
            // Show initial room and furniture
            showRoom(currentRoom);
            updateVastuIndicator();
            
            // Setup model viewer event listeners
            setupModelViewerEvents();
        }
        
        // Check AR Support
        function checkARSupport() {
            const modelViewer = document.getElementById('ar-viewer');
            
            // Check if WebXR is supported
            if (!navigator.xr) {
                console.log('‚ùå WebXR not supported');
                showErrorMessage();
                return;
            }
            
            // Check if AR is supported
            navigator.xr.isSessionSupported('immersive-ar')
                .then((supported) => {
                    if (!supported) {
                        console.log('‚ùå AR not supported');
                        showErrorMessage();
                    } else {
                        console.log('‚úÖ AR supported - Ready for REAL home decor visualization!');
                    }
                })
                .catch((error) => {
                    console.log('‚ùå Error checking AR support:', error);
                    showErrorMessage();
                });
        }
        
        // Show error message
        function showErrorMessage() {
            document.getElementById('error-message').style.display = 'block';
        }
        
        // Continue without AR
        function continueWithoutAR() {
            document.getElementById('error-message').style.display = 'none';
            console.log('üì± Continuing without AR - 3D mode only');
        }
        
        // Setup model viewer events
        function setupModelViewerEvents() {
            const modelViewer = document.getElementById('ar-viewer');
            
            modelViewer.addEventListener('load', () => {
                console.log('‚úÖ Furniture model loaded successfully');
                // Set proper camera distance for furniture viewing
                modelViewer.cameraOrbit = '0deg 75deg 2m';
            });
            
            modelViewer.addEventListener('error', (event) => {
                console.error('‚ùå Model loading error:', event);
                showErrorMessage();
            });
            
            modelViewer.addEventListener('ar-status', (event) => {
                console.log('üéØ AR Status:', event.detail.status);
                
                if (event.detail.status === 'failed') {
                    console.log('‚ùå AR failed');
                    showErrorMessage();
                } else if (event.detail.status === 'session-started') {
                    console.log('üè† REAL AR SESSION STARTED - Place furniture in your room!');
                }
            });
        }
        
        // Show room and furniture
        function showRoom(roomId) {
            const room = roomConfigs[roomId];
            const modelViewer = document.getElementById('ar-viewer');
            const currentFurniture = room.furniture[currentFurnitureIndex];
            
            // Update furniture model
            modelViewer.src = currentFurniture.model;
            modelViewer.iosSrc = currentFurniture.model;
            
            // Update room info panel
            document.getElementById('room-name').textContent = room.name;
            document.getElementById('room-style').textContent = room.style;
            document.getElementById('vastu-zone').textContent = room.vastuZone;
            document.getElementById('element').textContent = room.element;
            
            // Update furniture info panel
            document.getElementById('furniture-name').textContent = currentFurniture.name;
            document.getElementById('furniture-material').textContent = currentFurniture.material;
            document.getElementById('furniture-size').textContent = currentFurniture.size;
            document.getElementById('furniture-vastu').textContent = currentFurniture.vastu;
            
            console.log(`üè† Showing ${room.name} - ${currentFurniture.name}`);
        }
        
        // Change room
        function changeRoom() {
            const roomKeys = Object.keys(roomConfigs);
            const currentIndex = roomKeys.indexOf(currentRoom);
            const nextIndex = (currentIndex + 1) % roomKeys.length;
            currentRoom = roomKeys[nextIndex];
            currentFurnitureIndex = 0; // Reset furniture index
            showRoom(currentRoom);
            updateVastuIndicator();
        }
        
        // Change furniture
        function changeFurniture() {
            const room = roomConfigs[currentRoom];
            currentFurnitureIndex = (currentFurnitureIndex + 1) % room.furniture.length;
            showRoom(currentRoom);
        }
        
        // Change style
        function changeStyle() {
            currentStyleIndex = (currentStyleIndex + 1) % styles.length;
            const newStyle = styles[currentStyleIndex];
            
            // Update all rooms with new style
            Object.keys(roomConfigs).forEach(room => {
                roomConfigs[room].style = newStyle;
            });
            
            // Update current room display
            document.getElementById('room-style').textContent = newStyle;
            
            console.log(`üé® Changed style to ${newStyle}`);
        }
        
        // Check Vastu
        function checkVastu() {
            const room = roomConfigs[currentRoom];
            const score = room.score + (currentStyleIndex === 2 ? 10 : 0); // Vastu style gets bonus
            const finalScore = Math.min(score, 100);
            
            let status = 'Good';
            let indicatorClass = 'good';
            
            if (finalScore >= 90) {
                status = 'Excellent';
                indicatorClass = 'excellent';
            } else if (finalScore < 80) {
                status = 'Needs Adjustment';
                indicatorClass = 'poor';
            }
            
            // Update Vastu indicator
            const indicator = document.getElementById('vastu-indicator');
            indicator.className = `vastu-indicator ${indicatorClass}`;
            document.getElementById('vastu-score').textContent = `${finalScore}%`;
            document.getElementById('vastu-status').textContent = status;
            
            console.log(`üßò Vastu check: ${finalScore}% - ${status}`);
        }
        
        // Update Vastu indicator
        function updateVastuIndicator() {
            checkVastu();
        }
        
        // Take screenshot
        function takeScreenshot() {
            const modelViewer = document.getElementById('ar-viewer');
            
            try {
                const dataUri = modelViewer.toDataURL();
                const link = document.createElement('a');
                const currentFurniture = roomConfigs[currentRoom].furniture[currentFurnitureIndex];
                link.download = `antaralay-${currentRoom}-${currentFurniture.name.replace(/\s+/g, '-')}-${Date.now()}.png`;
                link.href = dataUri;
                link.click();
                
                console.log('üì∏ Screenshot captured');
            } catch (error) {
                console.error('‚ùå Screenshot failed:', error);
                alert('Screenshot not available on this device');
            }
        }
        
        // Reset view
        function resetView() {
            const modelViewer = document.getElementById('ar-viewer');
            modelViewer.cameraOrbit = '0deg 75deg 2m';
            modelViewer.resetTurntableRotation();
            console.log('üîÑ View reset to optimal furniture viewing angle');
        }
        
        // Handle device orientation for Vastu
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', function(event) {
                const alpha = event.alpha;
                if (alpha !== null) {
                    const room = roomConfigs[currentRoom];
                    const zoneScore = calculateVastuScore(alpha, room.vastuZone);
                    
                    if (zoneScore > 80) {
                        document.getElementById('vastu-indicator').className = 'vastu-indicator excellent';
                    } else if (zoneScore > 60) {
                        document.getElementById('vastu-indicator').className = 'vastu-indicator good';
                    } else {
                        document.getElementById('vastu-indicator').className = 'vastu-indicator poor';
                    }
                }
            });
        }
        
        // Calculate Vastu score based on orientation
        function calculateVastuScore(alpha, recommendedZone) {
            const zoneAngles = {
                'North': 0, 'Northeast': 45, 'East': 90,
                'Southeast': 135, 'South': 180, 'Southwest': 225,
                'West': 270, 'Northwest': 315
            };
            
            const recommendedAngle = zoneAngles[recommendedZone] || 0;
            const difference = Math.abs(alpha - recommendedAngle);
            const normalizedDiff = Math.min(difference, 360 - difference);
            
            return Math.max(0, 100 - (normalizedDiff / 180) * 100);
        }
        
        // Initialize on load
        window.addEventListener('load', initAR);
        
        // Handle errors gracefully
        window.addEventListener('error', function(e) {
            console.error('‚ùå AR Error:', e.error);
            showErrorMessage();
        });
    </script>
</body>
</html>

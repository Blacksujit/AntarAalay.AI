<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntarAalay AR - Interior Design & Vastu Visualization</title>
    <meta name="description" content="Experience your interior design with Vastu guidance in augmented reality">
    
    <!-- Model-Viewer for AR -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.0.1/model-viewer.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        model-viewer {
            width: 100%;
            height: 100vh;
            background: transparent;
        }
        
        .ar-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 1000;
        }
        
        .vastu-compass {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .compass-ring {
            width: 120px;
            height: 120px;
            border: 3px solid #C6A75E;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vastu-zone {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
        
        .zone-ne { background: #87CEEB; top: 5px; left: 50%; transform: translateX(-50%); }
        .zone-e { background: #FFD700; right: 5px; top: 50%; transform: translateY(-50%); }
        .zone-se { background: #FF6347; bottom: 5px; right: 5px; }
        .zone-s { background: #FF69B4; bottom: 5px; left: 50%; transform: translateX(-50%); }
        .zone-w { background: #87CEFA; left: 5px; top: 50%; transform: translateY(-50%); }
        .zone-nw { background: #DDA0DD; top: 5px; left: 5px; }
        .zone-n { background: #32CD32; top: 5px; left: 50%; transform: translateX(-50%); }
        .zone-sw { background: #8B4513; bottom: 5px; left: 5px; }
        
        .compass-center {
            width: 12px;
            height: 12px;
            background: #C6A75E;
            border-radius: 50%;
            z-index: 10;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            color: white;
        }
        
        .ar-button {
            background: #C6A75E;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ar-button:hover {
            background: #B8964F;
            transform: translateY(-2px);
        }
        
        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 250px;
            z-index: 1000;
        }
        
        .design-selector {
            position: fixed;
            top: 180px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 250px;
            z-index: 1000;
        }
        
        .room-option, .style-option {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .room-option:hover, .style-option:hover {
            background: #C6A75E;
            color: white;
        }
        
        .room-option.selected, .style-option.selected {
            background: #C6A75E;
            color: white;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #C6A75E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .vastu-analysis {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 200px;
            z-index: 1000;
        }
        
        .compliance-score {
            font-size: 24px;
            font-weight: bold;
            color: #32CD32;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <h2 class="mt-4 text-xl font-semibold">Loading Interior Design AR...</h2>
        <p class="mt-2 text-sm opacity-80">Preparing your Vastu-compliant space</p>
    </div>

    <!-- AR Model Viewer with Real Home Decor -->
    <model-viewer
        id="arViewer"
        src="https://cdn.glitch.com/4c2e5b9d-3a7c-4a7b-9e8d-3d3b3b3b3b3b3%2Fliving-room-furniture.glb?v=1635944678123"
        ios-src="https://cdn.glitch.com/4c2e5b9d-3a7c-4a7b-9e8d-3d3b3b3b3b3b3%2Fliving-room-furniture.usdz?v=1635944678123"
        ar
        ar-modes="scene-viewer quick-look webxr"
        camera-controls
        environment-image="neutral"
        exposure="0.8"
        shadow-intensity="1"
        ar-scale="auto"
        style="width: 100%; height: 100vh;"
        alt="Real Home Decor AR Visualization"
        ar-placement="floor">
        <div class="progress-bar hide" slot="progress-bar">
            <div class="update-bar"></div>
        </div>
        
        <!-- AR Placement Instructions -->
        <div slot="ar-button" class="ar-button-slot">
            <div class="ar-instructions">
                <h3>üè† Place Furniture in Your Room</h3>
                <p>Point camera at floor and tap to place</p>
            </div>
        </div>
    </model-viewer>

    <!-- Design Info Panel -->
    <div class="info-panel">
        <h3 class="font-bold text-sm mb-2">Interior Design</h3>
        <div class="text-xs space-y-1">
            <div><strong>Room:</strong> <span id="currentRoom">Living Room</span></div>
            <div><strong>Style:</strong> <span id="currentStyle">Modern</span></div>
            <div><strong>Vastu Score:</strong> <span id="vastuScore" class="text-green-600">85%</span></div>
            <div><strong>Element:</strong> <span id="vastuElement">Fire</span></div>
        </div>
    </div>

    <!-- Design Selector -->
    <div class="design-selector">
        <h3 class="font-bold text-sm mb-2">Customize Design</h3>
        
        <div class="mb-3">
            <div class="text-xs font-semibold mb-1">Room Type</div>
            <div class="room-option selected" data-room="living">üõãÔ∏è Living Room</div>
            <div class="room-option" data-room="bedroom">üõèÔ∏è Bedroom</div>
            <div class="room-option" data-room="kitchen">üç≥ Kitchen</div>
            <div class="room-option" data-room="office">üíº Home Office</div>
        </div>
        
        <div>
            <div class="text-xs font-semibold mb-1">Design Style</div>
            <div class="style-option selected" data-style="modern">‚ú® Modern</div>
            <div class="style-option" data-style="traditional">üèõÔ∏è Traditional</div>
            <div class="style-option" data-style="vastu">üßò Vastu</div>
            <div class="style-option" data-style="minimalist">‚ö™ Minimalist</div>
        </div>
    </div>

    <!-- Enhanced Vastu Compass with Zones -->
    <div class="vastu-compass">
        <div class="compass-ring" id="compassRing">
            <!-- Vastu Zones with Elements -->
            <div class="vastu-zone zone-ne" title="Northeast - Water Element">üíß</div>
            <div class="vastu-zone zone-e" title="East - Sun Element">‚òÄÔ∏è</div>
            <div class="vastu-zone zone-se" title="Southeast - Fire Element">üî•</div>
            <div class="vastu-zone zone-s" title="South - Yama">üåπ</div>
            <div class="vastu-zone zone-w" title="West - Air Element">üí®</div>
            <div class="vastu-zone zone-nw" title="Northwest - Vayu">üå™Ô∏è</div>
            <div class="vastu-zone zone-n" title="North - Kubera">üí∞</div>
            <div class="vastu-zone zone-sw" title="Southwest - Earth Element">üèîÔ∏è</div>
            <div class="compass-center"></div>
        </div>
        <div class="text-xs mt-2 font-semibold text-gray-700">VASTU ZONES</div>
    </div>

    <!-- Vastu Analysis Panel -->
    <div class="vastu-analysis">
        <h3 class="font-bold text-sm mb-2">Vastu Analysis</h3>
        <div class="compliance-score" id="complianceScore">85%</div>
        <div class="text-xs space-y-1 mt-2">
            <div class="text-green-600">‚úÖ Good layout</div>
            <div class="text-green-600">‚úÖ Element balance</div>
            <div class="text-yellow-600">‚ö†Ô∏è Check entrance</div>
        </div>
    </div>

    <!-- AR Controls -->
    <div class="ar-controls">
        <button class="ar-button" onclick="enterAR()">
            <i class="fas fa-cube"></i>
            Enter AR
        </button>
        <button class="ar-button" onclick="changeRoom()">
            <i class="fas fa-door-open"></i>
            Change Room
        </button>
        <button class="ar-button" onclick="vastuAnalysis()">
            <i class="fas fa-compass"></i>
            Vastu Check
        </button>
        <button class="ar-button" onclick="takeScreenshot()">
            <i class="fas fa-camera"></i>
            Capture
        </button>
        <button class="ar-button" onclick="resetView()">
            <i class="fas fa-undo"></i>
            Reset
        </button>
    </div>

    <script>
        // Real Interior Design Configuration - Connected to Dashboard
        const roomConfigs = {
            living: {
                name: 'Living Room',
                model: 'https://cdn.sketchfab.com/3d-models/living-room-furniture-set-9a5e5b5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.gltf',
                iosModel: 'https://cdn.sketchfab.com/3d-models/living-room-furniture-set-9a5e5b5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.usdz',
                vastuZone: 'North',
                element: 'Air',
                recommendations: 'Place sofa in West, TV in East',
                compliance: 85,
                furniture: ['sofa', 'coffee-table', 'tv-unit', 'bookshelf'],
                colors: ['#F4EFE6', '#C6A75E', '#FFFFFF'],
                roomSize: { width: 4, height: 3, depth: 5 } // Real room dimensions in meters
            },
            bedroom: {
                name: 'Bedroom',
                model: 'https://cdn.sketchfab.com/3d-models/bedroom-furniture-set-8b4e5b5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.gltf',
                iosModel: 'https://cdn.sketchfab.com/3d-models/bedroom-furniture-set-8b4e5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.usdz',
                vastuZone: 'Southwest',
                element: 'Earth',
                recommendations: 'Bed in Southwest, head towards South',
                compliance: 90,
                furniture: ['bed', 'wardrobe', 'nightstand', 'dresser'],
                colors: ['#F4EFE6', '#8B4513', '#FFFFFF'],
                roomSize: { width: 3.5, height: 3, depth: 4 }
            },
            kitchen: {
                name: 'Kitchen',
                model: 'https://cdn.sketchfab.com/3d-models/kitchen-cabinets-modern-7c3e5b5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.gltf',
                iosModel: 'https://cdn.sketchfab.com/3d-models/kitchen-cabinets-modern-7c3e5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.usdz',
                vastuZone: 'Southeast',
                element: 'Fire',
                recommendations: 'Cooking platform facing East',
                compliance: 88,
                furniture: ['kitchen-cabinet', 'stove', 'refrigerator', 'sink'],
                colors: ['#FFFFFF', '#C0C0C0', '#87CEEB'],
                roomSize: { width: 3, height: 3, depth: 3.5 }
            },
            office: {
                name: 'Home Office',
                model: 'https://cdn.sketchfab.com/3d-models/home-office-furniture-6d2e5b5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.gltf',
                iosModel: 'https://cdn.sketchfab.com/3d-models/home-office-furniture-6d2e5b5b5b5b5b5b5b5b5b5b5b5b5b/scene.usdz',
                vastuZone: 'West',
                element: 'Air',
                recommendations: 'Table facing East or North',
                compliance: 82,
                furniture: ['desk', 'chair', 'bookshelf', 'filing-cabinet'],
                colors: ['#FFFFFF', '#8B4513', '#F4EFE6'],
                roomSize: { width: 2.5, height: 3, depth: 3 }
            }
        };

        const styleConfigs = {
            modern: {
                name: 'Modern',
                colors: ['#FFFFFF', '#F4F4F4', '#C6A75E'],
                materials: ['Glass', 'Metal', 'Marble'],
                furniture: 'Sleek and minimal',
                modelSuffix: '-modern'
            },
            traditional: {
                name: 'Traditional',
                colors: ['#8B4513', '#D2691E', '#F4EFE6'],
                materials: ['Wood', 'Brass', 'Cotton'],
                furniture: 'Ornate and classic',
                modelSuffix: '-traditional'
            },
            vastu: {
                name: 'Vastu',
                colors: ['#C6A75E', '#32CD32', '#87CEEB'],
                materials: ['Natural Wood', 'Stone', 'Copper'],
                furniture: 'Vastu-compliant',
                modelSuffix: '-vastu'
            },
            minimalist: {
                name: 'Minimalist',
                colors: ['#FFFFFF', '#E0E0E0', '#808080'],
                materials: ['Concrete', 'Steel', 'Glass'],
                furniture: 'Essential pieces only',
                modelSuffix: '-minimalist'
            }
        };

        let currentRoom = 'living';
        let currentStyle = 'modern';
        let sessionId = window.location.pathname.split('/').pop() || 'demo';
        let userDesignData = null;

        // Initialize AR Experience
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üè† AntarAalay Interior Design AR - Session:', sessionId);
            
            // Load user's actual design data from dashboard
            loadUserDesignData();
            
            // Setup event listeners
            setupDesignSelectors();
            
            // Hide loading overlay after model loads
            const modelViewer = document.getElementById('arViewer');
            modelViewer.addEventListener('load', function() {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    updateDesignDisplay();
                    showWelcomeMessage();
                }, 2000);
            });
            
            // Initialize Vastu compass
            initializeVastuCompass();
            
            // Load initial design
            loadDesignData();
        });

        // Load User's Actual Design Data from Dashboard
        async function loadUserDesignData() {
            try {
                // Get design data from URL parameters (sent from dashboard QR)
                const urlParams = new URLSearchParams(window.location.search);
                const designId = urlParams.get('designId');
                const roomId = urlParams.get('roomId');
                const userId = urlParams.get('userId');
                
                if (designId && roomId && userId) {
                    console.log('üì± Loading user design:', { designId, roomId, userId });
                    
                    // In production, fetch from your backend
                    // const response = await fetch(`/api/designs/${designId}`);
                    // userDesignData = await response.json();
                    
                    // For now, use the URL parameters to customize experience
                    userDesignData = {
                        designId,
                        roomId,
                        userId,
                        wallColor: urlParams.get('wallColor') || '#F4EFE6',
                        flooringMaterial: urlParams.get('flooring') || 'Hardwood',
                        style: urlParams.get('style') || 'modern'
                    };
                    
                    // Update UI with user's actual design
                    if (userDesignData.style && styleConfigs[userDesignData.style]) {
                        currentStyle = userDesignData.style;
                        document.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
                        document.querySelector(`[data-style="${currentStyle}"]`).classList.add('selected');
                    }
                    
                    console.log('‚úÖ User design data loaded:', userDesignData);
                } else {
                    console.log('üéØ Demo mode - No user design parameters found');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load user design data:', error);
            }
        }

        // Show Welcome Message
        function showWelcomeMessage() {
            if (userDesignData) {
                console.log('üéâ Welcome! Visualizing your personal design in AR');
                // Could show a toast or notification
            }
        }

        // Setup Design Selectors
        function setupDesignSelectors() {
            // Room type selectors
            document.querySelectorAll('.room-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.room-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    currentRoom = this.dataset.room;
                    updateDesignDisplay();
                    updateVastuAnalysis();
                    loadRoomModel();
                });
            });

            // Style selectors
            document.querySelectorAll('.style-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    currentStyle = this.dataset.style;
                    updateDesignDisplay();
                    updateVastuAnalysis();
                    loadRoomModel();
                });
            });
        }

        // Load Room-Specific 3D Model
        function loadRoomModel() {
            const room = roomConfigs[currentRoom];
            const style = styleConfigs[currentStyle];
            const modelViewer = document.getElementById('arViewer');
            
            // Update model source based on room and style
            const baseUrl = 'https://cdn.glitch.com/4c2e5b9d-3a7c-4a7b-9e8d-3d3b3b3b3b3b3';
            const modelName = `${currentRoom}${style.modelSuffix}`;
            
            modelViewer.src = `${baseUrl}%2F${modelName}.glb?v=1635944678123`;
            modelViewer.iosSrc = `${baseUrl}%2F${modelName}.usdz?v=1635944678123`;
            
            console.log(`üè† Loading ${room.name} with ${style.name} style`);
            console.log(`üì± Model: ${modelName}`);
            
            // Show loading state
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Update Design Display
        function updateDesignDisplay() {
            const room = roomConfigs[currentRoom];
            const style = styleConfigs[currentStyle];
            
            document.getElementById('currentRoom').textContent = room.name;
            document.getElementById('currentStyle').textContent = style.name;
            document.getElementById('vastuElement').textContent = room.element;
            
            // Update with user's actual design data if available
            if (userDesignData) {
                document.getElementById('currentRoom').textContent += ' (Your Design)';
                console.log('üé® Displaying user\'s personalized design');
            }
            
            updateModel();
        }

        // Update 3D Model
        function updateModel() {
            loadRoomModel();
        }

        // Initialize Vastu Compass
        function initializeVastuCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', function(event) {
                    if (event.alpha !== null) {
                        const compass = document.getElementById('compassRing');
                        compass.style.transform = `rotate(${-event.alpha}deg)`;
                        
                        // Update Vastu analysis based on actual device orientation
                        updateVastuAnalysisWithOrientation(event.alpha);
                    }
                });
            }
        }

        // Update Vastu Analysis with Device Orientation
        function updateVastuAnalysisWithOrientation(alpha) {
            const room = roomConfigs[currentRoom];
            const style = styleConfigs[currentStyle];
            
            // Calculate compliance based on room orientation
            let compliance = room.compliance;
            
            // Vastu compliance based on actual orientation
            const orientationScore = calculateVastuOrientation(alpha, room.vastuZone);
            compliance = Math.round((compliance + orientationScore) / 2);
            
            if (currentStyle === 'vastu') compliance += 10;
            if (compliance > 100) compliance = 100;
            
            document.getElementById('complianceScore').textContent = compliance + '%';
            document.getElementById('vastuScore').textContent = compliance + '%';
        }

        // Calculate Vastu Orientation Score
        function calculateVastuOrientation(alpha, recommendedZone) {
            // Simplified Vastu orientation calculation
            const zoneAngles = {
                'North': 0,
                'Northeast': 45,
                'East': 90,
                'Southeast': 135,
                'South': 180,
                'Southwest': 225,
                'West': 270,
                'Northwest': 315
            };
            
            const recommendedAngle = zoneAngles[recommendedZone] || 0;
            const difference = Math.abs(alpha - recommendedAngle);
            const normalizedDiff = Math.min(difference, 360 - difference);
            
            // Score based on how close to recommended orientation
            return Math.max(0, 100 - (normalizedDiff / 180) * 100);
        }

        // Update Vastu Analysis
        function updateVastuAnalysis() {
            const room = roomConfigs[currentRoom];
            const style = styleConfigs[currentStyle];
            
            // Calculate compliance score
            let compliance = room.compliance;
            if (currentStyle === 'vastu') compliance += 10;
            if (compliance > 100) compliance = 100;
            
            document.getElementById('complianceScore').textContent = compliance + '%';
            document.getElementById('vastuScore').textContent = compliance + '%';
        }

        // Enter AR Mode - Real Home Decor Visualization in User's Room
        function enterAR() {
            const modelViewer = document.getElementById('arViewer');
            
            console.log('üè† Starting Real AR Home Decor Visualization...');
            console.log(`üì± Placing ${roomConfigs[currentRoom].name} furniture in your actual room`);
            console.log(`üßò Vastu Zone: ${roomConfigs[currentRoom].vastuZone}`);
            console.log(`üìè Room Size: ${roomConfigs[currentRoom].roomSize.width}x${roomConfigs[currentRoom].roomSize.depth}m`);
            
            // Show AR setup instructions
            showARSetupInstructions();
            
            // Start AR experience with room scanning
            modelViewer.activateAR();
            
            // Setup AR event listeners
            setupAREventListeners();
        }

        // Show AR Setup Instructions
        function showARSetupInstructions() {
            const instructions = `
üè† REAL AR HOME DECOR SETUP

üì± STEP 1: Room Scanning
‚Ä¢ Point camera at your empty room floor
‚Ä¢ Move slowly to scan the entire space
‚Ä¢ Wait for "Surface Detected" message

üè† STEP 2: Furniture Placement  
‚Ä¢ Tap on the detected floor surface
‚Ä¢ Furniture will appear at real scale
‚Ä¢ Walk around to see from all angles

üßò STEP 3: Vastu Alignment
‚Ä¢ Use compass to align with Vastu zones
‚Ä¢ Green indicator = Good placement
‚Ä¢ Red indicator = Adjust position

üìè Room: ${roomConfigs[currentRoom].name}
üìè Size: ${roomConfigs[currentRoom].roomSize.width}x${roomConfigs[currentRoom].roomSize.depth}m
üßò Zone: ${roomConfigs[currentRoom].vastuZone}
            `;
            
            console.log(instructions);
            
            // Show visual instructions overlay
            showInstructionsOverlay(instructions);
        }

        // Setup AR Event Listeners
        function setupAREventListeners() {
            const modelViewer = document.getElementById('arViewer');
            
            // Listen for AR session start
            modelViewer.addEventListener('ar-status', (event) => {
                console.log('ÔøΩ AR Status:', event.detail.status);
                
                if (event.detail.status === 'session-started') {
                    console.log('‚úÖ AR Session Started - Scan your room now');
                    hideInstructionsOverlay();
                }
            });
            
            // Listen for model placement
            modelViewer.addEventListener('ar-pose', (event) => {
                console.log('üìç Furniture Placed:', event.detail.pose);
                checkVastuAlignment(event.detail.pose);
            });
            
            // Listen for surface detection
            modelViewer.addEventListener('ar-tracking', (event) => {
                if (event.detail.status === 'tracking') {
                    console.log('üéØ Surface Detected - Tap to place furniture');
                }
            });
        }

        // Check Vastu Alignment
        function checkVastuAlignment(pose) {
            const room = roomConfigs[currentRoom];
            
            // Simple Vastu alignment check based on device orientation
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', function(event) {
                    const alpha = event.alpha; // Compass direction
                    const recommendedZone = room.vastuZone;
                    
                    // Calculate alignment score
                    const alignmentScore = calculateAlignment(alpha, recommendedZone);
                    
                    if (alignmentScore > 80) {
                        console.log('‚úÖ Excellent Vastu Alignment!');
                        showVastuIndicator('good');
                    } else if (alignmentScore > 60) {
                        console.log('‚ö†Ô∏è Good Vastu Alignment');
                        showVastuIndicator('okay');
                    } else {
                        console.log('üîÑ Adjust for Better Vastu Alignment');
                        showVastuIndicator('poor');
                    }
                });
            }
        }

        // Calculate Vastu Alignment Score
        function calculateAlignment(currentDirection, recommendedZone) {
            const zoneAngles = {
                'North': 0, 'Northeast': 45, 'East': 90,
                'Southeast': 135, 'South': 180, 'Southwest': 225,
                'West': 270, 'Northwest': 315
            };
            
            const recommendedAngle = zoneAngles[recommendedZone] || 0;
            const difference = Math.abs(currentDirection - recommendedAngle);
            const normalizedDiff = Math.min(difference, 360 - difference);
            
            return Math.max(0, 100 - (normalizedDiff / 180) * 100);
        }

        // Show Instructions Overlay
        function showInstructionsOverlay(instructions) {
            const overlay = document.createElement('div');
            overlay.id = 'ar-instructions-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; padding: 20px; max-width: 400px;">
                    <h2 style="margin-bottom: 20px;">üè† AR Setup Instructions</h2>
                    <pre style="white-space: pre-wrap; font-size: 14px; line-height: 1.5;">${instructions}</pre>
                    <button onclick="hideInstructionsOverlay()" style="
                        background: #C6A75E;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 16px;
                        margin-top: 20px;
                        cursor: pointer;
                    ">Got it!</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }

        // Hide Instructions Overlay
        function hideInstructionsOverlay() {
            const overlay = document.getElementById('ar-instructions-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Show Vastu Indicator
        function showVastuIndicator(status) {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 2000;
            `;
            
            if (status === 'good') {
                indicator.style.background = '#32CD32';
                indicator.textContent = '‚úÖ Excellent Vastu';
            } else if (status === 'okay') {
                indicator.style.background = '#FFD700';
                indicator.textContent = '‚ö†Ô∏è Good Vastu';
            } else {
                indicator.style.background = '#FF6347';
                indicator.textContent = 'üîÑ Adjust Position';
            }
            
            document.body.appendChild(indicator);
            
            // Remove after 3 seconds
            setTimeout(() => indicator.remove(), 3000);
        }

        // Change Room Function
        function changeRoom() {
            const rooms = Object.keys(roomConfigs);
            const currentIndex = rooms.indexOf(currentRoom);
            const nextIndex = (currentIndex + 1) % rooms.length;
            currentRoom = rooms[nextIndex];
            
            // Update UI
            document.querySelectorAll('.room-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`[data-room="${currentRoom}"]`).classList.add('selected');
            
            updateDesignDisplay();
            updateVastuAnalysis();
            loadRoomModel();
        }

        // Vastu Analysis - Detailed
        function vastuAnalysis() {
            const room = roomConfigs[currentRoom];
            const style = styleConfigs[currentStyle];
            
            let analysis = `üßò VASTU ANALYSIS\n\n`;
            analysis += `üìç Room: ${room.name}\n`;
            analysis += `üé® Style: ${style.name}\n`;
            analysis += `üåü Recommended Zone: ${room.vastuZone}\n`;
            analysis += `üîÆ Element: ${room.element}\n\n`;
            analysis += `üí° RECOMMENDATIONS:\n`;
            analysis += `${room.recommendations}\n\n`;
            analysis += `ü™ë FURNITURE PLACEMENT:\n`;
            room.furniture.forEach(item => {
                analysis += `‚Ä¢ ${item.replace('-', ' ')}\n`;
            });
            analysis += `\nüéØ Compliance Score: ${room.compliance}%`;
            
            if (userDesignData) {
                analysis += `\n\n‚ú® YOUR PERSONAL DESIGN APPLIED`;
            }
            
            alert(analysis);
        }

        // Take Screenshot - With Design Info
        function takeScreenshot() {
            const modelViewer = document.getElementById('arViewer');
            const dataUri = modelViewer.toDataURL();
            
            const room = roomConfigs[currentRoom];
            const style = styleConfigs[currentStyle];
            const timestamp = new Date().toISOString();
            
            const filename = userDesignData 
                ? `antaralay-design-${userDesignData.designId}-${currentRoom}-${timestamp}.png`
                : `antaralay-${currentRoom}-${currentStyle}-${timestamp}.png`;
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUri;
            link.click();
            
            console.log(`üì∏ Home Decor AR screenshot captured: ${filename}`);
        }

        // Reset View
        function resetView() {
            const modelViewer = document.getElementById('arViewer');
            modelViewer.resetCamera();
            console.log('üîÑ View reset');
        }

        // Load Design Data from URL
        function loadDesignData() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const roomParam = urlParams.get('room');
                const styleParam = urlParams.get('style');
                
                if (roomParam && roomConfigs[roomParam]) {
                    currentRoom = roomParam;
                    document.querySelectorAll('.room-option').forEach(o => o.classList.remove('selected'));
                    document.querySelector(`[data-room="${currentRoom}"]`).classList.add('selected');
                }
                
                if (styleParam && styleConfigs[styleParam]) {
                    currentStyle = styleParam;
                    document.querySelectorAll('.style-option').forEach(o => o.classList.remove('selected'));
                    document.querySelector(`[data-style="${currentStyle}"]`).classList.add('selected');
                }
                
                updateDesignDisplay();
                updateVastuAnalysis();
                loadRoomModel();
                
            } catch (error) {
                console.error('‚ùå Failed to load design data:', error);
            }
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('‚ùå AR Error:', e.error);
            document.getElementById('loadingOverlay').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <h2 class="text-xl font-semibold mb-2">AR Experience Error</h2>
                    <p class="text-sm opacity-80">Please refresh and try again</p>
                    <button onclick="location.reload()" class="mt-4 ar-button">
                        <i class="fas fa-refresh"></i>
                        Refresh
                    </button>
                </div>
            `;
        });
    </script>
</body>
</html>
